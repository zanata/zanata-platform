<?xml version="1.0"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>org.zanata</groupId>
    <artifactId>server</artifactId>
    <version>4.1.0-SNAPSHOT</version>
  </parent>
  <artifactId>functional-test</artifactId>
  <!--if we want to use pom packaging, we need to explicitly enable some plugins and various things-->
  <!--<packaging>pom</packaging>-->
  <packaging>takari-jar</packaging>
  <name>functional-test</name>

  <properties>
    <allow.deploy.skip>true</allow.deploy.skip>
    <selenium.version>2.45.0</selenium.version>

    <!--Cargo Settings -->
    <cargo.host>localhost</cargo.host>
    <!--jboss port offset -->
    <cargo.port.offset>0</cargo.port.offset>
    <!-- This may be changed by the JBOSS_HTTP_PORT profile -->
    <!-- This needs to agree with the http socket-binding in standalone.xml -->
    <cargo.servlet.port>8180</cargo.servlet.port>
    <cargo.jboss.management-http.port>10090</cargo.jboss.management-http.port>
    <cargo.jboss.management-native.port>10099</cargo.jboss.management-native.port>
    <cargo.extract.dir>${project.build.directory}/cargo/installs</cargo.extract.dir>
    <cargo.container.home>${project.build.directory}/jboss/container</cargo.container.home>
    <context.path>zanata</context.path>

    <!--mysql-maven-plugin will use these setup-->
    <ds.database>root</ds.database>
    <ds.username>root</ds.username>
    <ds.password>root</ds.password>
    <!-- Note that mysql.port is not set initially -->
    <ds.connection.url>jdbc:mysql://localhost:${mysql.port}/${ds.database}?characterEncoding=UTF-8</ds.connection.url>
    <ds.driver.class>com.mysql.jdbc.Driver</ds.driver.class>
    <!-- skipAfterFailureCount=0 due to https://issues.apache.org/jira/browse/SUREFIRE-1219 -->
    <failsafe.skipAfterFailureCount>0</failsafe.skipAfterFailureCount>
    <failsafe.rerunFailingTestsCount>1</failsafe.rerunFailingTestsCount>

    <maven.javadoc.skip>true</maven.javadoc.skip>
    <maven.site.skip>true</maven.site.skip>

    <!-- mysql-dist 5.5.34 is the default version, but 5.6.14 may also work.
         mysql-dist 5.6.21 won't work due to
         https://github.com/jcabi/jcabi-mysql-maven-plugin/issues/47
     -->
    <mysql.dist.version>5.5.34</mysql.dist.version>
    <!-- 0 is the Linux default (case sensitive), but 1 (lowercase,
         case-insensitive) is recommended for InnoDB.
         See https://dev.mysql.com/doc/refman/5.1/en/server-system-variables.html#sysvar_lower_case_table_names
     -->
    <mysql.lower_case_table_names>0</mysql.lower_case_table_names>

    <zanata.instance.url>http://${cargo.host}:${cargo.servlet.port}/${context.path}/</zanata.instance.url>
    <zanata.apikey>b6d7044e9ee3b2447c28fb7c50d86d98</zanata.apikey>
    <zanata.translatorkey>d83882201764f7d339e97c4b087f0806</zanata.translatorkey>
    <zanata.sample.projects.basedir>${project.build.testOutputDirectory}/sample-projects</zanata.sample.projects.basedir>

    <webdriver.log.file>${project.build.directory}/browser_console.log</webdriver.log.file>
    <webdriver.chrome.bin>/opt/google/chrome/google-chrome</webdriver.chrome.bin>
    <!-- this decides what web driver type we intended to use-->
    <webdriver.type>chrome</webdriver.type>
    <webdriver.log>${project.build.directory}/webdriver.log</webdriver.log>
    <webdriver.screenshot.dir>${project.build.directory}/screenshots</webdriver.screenshot.dir>
    <webdriver.wait>20</webdriver.wait>
    <googleopenid.credentials>zanata.user.1:</googleopenid.credentials>
    <!-- on jenkins, this needs to be set to empty - so that cargo can shutdown. see http://stackoverflow.com/questions/1096642/tomcat-failed-to-shutdown -->
    <cargo.debug.jvm.args>
      -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8787
      -Xnoagent -Djava.compiler=NONE
    </cargo.debug.jvm.args>
    <!-- this property can be used to control what test needs to be run by failsafe -->
    <default.test.patterns>**/BasicAcceptanceTestSuite.java</default.test.patterns>
    <include.test.patterns>${default.test.patterns}</include.test.patterns>
    <hibernate.search.default.indexBase>${project.build.directory}/zanataindex</hibernate.search.default.indexBase>
    <javamelody.storage-directory>${project.build.directory}/zanatastats</javamelody.storage-directory>
    <!-- This may be changed by the SMTP_PORT profile -->
    <smtp.port>2552</smtp.port>
    <jndi-remote-client.groupId>org.wildfly.core</jndi-remote-client.groupId>
    <jndi-remote-client.artifactId>wildfly-controller-client</jndi-remote-client.artifactId>
    <jndi-remote-client.version>${wildfly.client.version}</jndi-remote-client.version>
    <standalone.xml.file>standalone.xml</standalone.xml.file>
  </properties>

  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.apache.httpcomponents</groupId>
        <artifactId>httpclient</artifactId>
        <version>4.3.6</version>
      </dependency>
      <dependency>
        <groupId>org.apache.httpcomponents</groupId>
        <artifactId>httpcore</artifactId>
        <version>4.3.3</version>
      </dependency>
      <dependency>
        <groupId>org.apache.httpcomponents</groupId>
        <artifactId>httpmime</artifactId>
        <version>4.3.3</version>
      </dependency>
      <dependency>
        <groupId>xerces</groupId>
        <artifactId>xercesImpl</artifactId>
        <version>2.11.0</version>
      </dependency>
      <!--<dependency>-->
        <!--<groupId>org.zanata</groupId>-->
        <!--<artifactId>zanata-rest-client</artifactId>-->
      <!--</dependency>-->
    </dependencies>
  </dependencyManagement>

  <dependencies>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>zanata-test-war</artifactId>
      <version>${project.version}</version>
      <type>war</type>
      <scope>provided</scope>
    </dependency>
    <dependency>
      <groupId>net.lightbody.bmp</groupId>
      <artifactId>browsermob-core-littleproxy</artifactId>
      <version>2.1.0-beta-4</version>
      <exclusions>
        <exclusion>
          <groupId>com.google.code.findbugs</groupId>
          <artifactId>jsr305</artifactId>
        </exclusion>
        <exclusion>
          <groupId>javax.annotation</groupId>
          <artifactId>jsr250-api</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>org.assertj</groupId>
      <artifactId>assertj-core</artifactId>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>com.fasterxml.jackson.core</groupId>
      <artifactId>jackson-annotations</artifactId>
      <version>2.6.3</version>
    </dependency>
    <dependency>
      <groupId>com.fasterxml.jackson.core</groupId>
      <artifactId>jackson-core</artifactId>
      <version>2.6.3</version>
    </dependency>
    <dependency>
      <groupId>com.fasterxml.jackson.core</groupId>
      <artifactId>jackson-databind</artifactId>
      <version>2.6.3</version>
    </dependency>
    <dependency>
      <groupId>org.bouncycastle</groupId>
      <artifactId>bcpkix-jdk15on</artifactId>
      <version>1.53</version>
    </dependency>
    <dependency>
      <groupId>org.bouncycastle</groupId>
      <artifactId>bcprov-jdk15on</artifactId>
      <version>1.53</version>
    </dependency>
    <dependency>
      <groupId>org.seleniumhq.selenium</groupId>
      <artifactId>selenium-api</artifactId>
      <version>${selenium.version}</version>
    </dependency>
    <dependency>
      <groupId>org.seleniumhq.selenium</groupId>
      <artifactId>selenium-chrome-driver</artifactId>
      <version>${selenium.version}</version>
    </dependency>
    <dependency>
      <groupId>org.seleniumhq.selenium</groupId>
      <artifactId>selenium-firefox-driver</artifactId>
      <version>${selenium.version}</version>
    </dependency>

    <dependency>
      <groupId>org.seleniumhq.selenium</groupId>
      <artifactId>selenium-remote-driver</artifactId>
      <version>${selenium.version}</version>
      <exclusions>
        <exclusion>
          <groupId>commons-logging</groupId>
          <artifactId>commons-logging</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>org.seleniumhq.selenium</groupId>
      <artifactId>selenium-support</artifactId>
      <version>${selenium.version}</version>
    </dependency>
    <dependency>
      <groupId>com.google.guava</groupId>
      <artifactId>guava</artifactId>
    </dependency>
    <dependency>
      <groupId>commons-lang</groupId>
      <artifactId>commons-lang</artifactId>
    </dependency>

    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
    </dependency>
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-api</artifactId>
    </dependency>
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-log4j12</artifactId>
    </dependency>

    <dependency>
      <groupId>org.subethamail</groupId>
      <artifactId>subethasmtp</artifactId>
      <version>3.1.7</version>
      <exclusions>
        <exclusion>
          <groupId>com.google.code.findbugs</groupId>
          <artifactId>jsr305</artifactId>
        </exclusion>
        <exclusion>
          <groupId>commons-logging</groupId>
          <artifactId>commons-logging</artifactId>
        </exclusion>
        <exclusion>
          <groupId>javax.mail</groupId>
          <artifactId>mail</artifactId>
        </exclusion>
      </exclusions>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>com.sun.mail</groupId>
      <artifactId>javax.mail</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.hamcrest</groupId>
      <artifactId>hamcrest-core</artifactId>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.hamcrest</groupId>
      <artifactId>hamcrest-library</artifactId>
      <scope>compile</scope>
    </dependency>

    <!-- cargo needs these-->
    <dependency>
      <groupId>${jdbc.groupId}</groupId>
      <artifactId>${jdbc.artifactId}</artifactId>
    </dependency>

    <dependency>
      <groupId>commons-io</groupId>
      <artifactId>commons-io</artifactId>
      <version>2.4</version>
    </dependency>

    <dependency>
      <groupId>org.zanata</groupId>
      <artifactId>zanata-common-api</artifactId>
      <exclusions>
        <exclusion>
          <groupId>org.jboss.resteasy</groupId>
          <artifactId>jaxrs-api</artifactId>
        </exclusion>
        <exclusion>
          <groupId>org.jboss.resteasy</groupId>
          <artifactId>resteasy-jaxrs</artifactId>
        </exclusion>
        <exclusion>
          <groupId>org.jboss.resteasy</groupId>
          <artifactId>resteasy-jaxb-provider</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>org.codehaus.jackson</groupId>
      <artifactId>jackson-core-asl</artifactId>
    </dependency>

    <!-- to use rest client in test -->
    <dependency>
      <groupId>org.zanata</groupId>
      <artifactId>zanata-rest-client</artifactId>
      <scope>test</scope>
      <exclusions>
        <exclusion>
          <groupId>org.apache.httpcomponents</groupId>
          <artifactId>httpclient</artifactId>
        </exclusion>
        <exclusion>
          <groupId>org.jboss.spec.javax.ws.rs</groupId>
          <artifactId>jboss-jaxrs-api_2.0_spec</artifactId>
        </exclusion>
        <exclusion>
          <groupId>org.jboss.spec.javax.annotation</groupId>
          <artifactId>jboss-annotations-api_1.2_spec</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>javax.validation</groupId>
      <artifactId>validation-api</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.apache.httpcomponents</groupId>
      <artifactId>httpclient</artifactId>
      <exclusions>
        <exclusion>
          <groupId>commons-logging</groupId>
          <artifactId>commons-logging</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>org.zanata</groupId>
      <artifactId>zanata-common-util</artifactId>
    </dependency>

    <dependency>
      <groupId>org.zanata</groupId>
      <artifactId>zanata-adapter-po</artifactId>
      <exclusions>
        <exclusion>
          <groupId>javax.xml.bind</groupId>
          <artifactId>jaxb-api</artifactId>
        </exclusion>
      </exclusions>
    </dependency>

    <dependency>
      <groupId>org.jboss.spec.javax.xml.bind</groupId>
      <artifactId>jboss-jaxb-api_2.2_spec</artifactId>
    </dependency>

    <dependency>
      <groupId>org.fedorahosted.openprops</groupId>
      <artifactId>openprops</artifactId>
    </dependency>

    <!-- to be able to create entities in functional test -->


    <!-- For remote JNDI lookup -->
    <dependency>
      <groupId>${jndi-remote-client.groupId}</groupId>
      <artifactId>${jndi-remote-client.artifactId}</artifactId>
      <version>${jndi-remote-client.version}</version>
      <scope>test</scope>
      <exclusions>
        <exclusion>
          <groupId>javax.xml.bind</groupId>
          <artifactId>jaxb-api</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <dependency>
      <groupId>org.jboss</groupId>
      <artifactId>jboss-remote-naming</artifactId>
      <version>2.0.4.Final</version>
      <scope>test</scope>
      <exclusions>
        <exclusion>
          <groupId>org.jboss.remoting</groupId>
          <artifactId>jboss-remoting</artifactId>
        </exclusion>
      </exclusions>
    </dependency>

    <dependency>
      <groupId>com.google.code.findbugs</groupId>
      <artifactId>annotations</artifactId>
    </dependency>

    <dependency>
      <groupId>joda-time</groupId>
      <artifactId>joda-time</artifactId>
    </dependency>

    <dependency>
      <groupId>com.jayway.awaitility</groupId>
      <artifactId>awaitility</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.jboss.resteasy</groupId>
      <artifactId>jaxrs-api</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.jboss.resteasy</groupId>
      <artifactId>resteasy-client</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>cglib</groupId>
      <artifactId>cglib-nodep</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.objenesis</groupId>
      <artifactId>objenesis</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.codehaus.groovy</groupId>
      <artifactId>groovy-all</artifactId>
      <scope>provided</scope>
    </dependency>

  </dependencies>

  <profiles>
    <profile>
      <id>jbosseap6</id>
      <activation>
        <property>
          <name>appserver</name>
          <value>jbosseap6</value>
        </property>
      </activation>
    </profile>
    <profile>
      <id>wildfly8</id>
      <activation>
        <property>
          <name>appserver</name>
          <value>wildfly8</value>
        </property>
      </activation>
      <properties>
        <standalone.xml.file>standalone_wildfly.xml</standalone.xml.file>
      </properties>
    </profile>

    <profile>
      <id>skipFuncTests</id>
      <activation>
        <property>
          <name>skipFuncTests</name>
        </property>
      </activation>
      <properties>
        <skipITs>true</skipITs>
      </properties>
    </profile>

    <profile>
      <id>allFuncTests</id>
      <activation>
        <property>
          <name>allFuncTests</name>
          <value>true</value>
        </property>
      </activation>
      <properties>
        <include.test.patterns>**/DetailedTestSuite.java</include.test.patterns>
      </properties>
      <build>
        <plugins>
          <plugin>
            <artifactId>maven-antrun-plugin</artifactId>
            <executions>
              <execution>
                <id>check-tests-enabled</id>
                <phase>validate</phase>
                <goals>
                  <goal>run</goal>
                </goals>
                <configuration>
                  <target xmlns:if="ant:if">
                    <echo if:set="skipFuncTests" message="WARNING: -DskipFuncTests takes precedence over -DallFuncTests" />
                    <echo if:set="skipITs" message="WARNING: -DskipITs takes precedence over -DallFuncTests" />
                    <echo if:set="skipTests" message="WARNING: -DskipTests takes precedence over -DallFuncTests" />
                  </target>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>

    <profile>
      <id>run-functional-test</id>
      <activation>
        <property>
          <name>!skipFuncTests</name>
        </property>
      </activation>
      <build>
        <plugins>
          <plugin>
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>build-helper-maven-plugin</artifactId>
            <executions>
              <execution>
                <goals>
                  <goal>reserve-network-port</goal>
                </goals>
                <phase>generate-test-resources</phase>
                <configuration>
                  <portNames>
                    <portName>mysql.port</portName>
                  </portNames>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.codehaus.gmavenplus</groupId>
            <artifactId>gmavenplus-plugin</artifactId>
            <executions>
              <execution>
                <id>extract-appserver</id>
                <phase>prepare-package</phase>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <artifactId>maven-dependency-plugin</artifactId>
            <executions>
              <execution>
                <goals>
                  <goal>unpack</goal>
                </goals>
                <configuration>
                  <artifactItems>
                    <artifactItem>
                      <groupId>com.jcabi</groupId>
                      <artifactId>mysql-dist</artifactId>
                      <version>${mysql.dist.version}</version>
                      <classifier>${mysql.classifier}</classifier>
                      <type>zip</type>
                      <overWrite>false</overWrite>
                      <outputDirectory>${project.build.directory}/mysql-dist</outputDirectory>
                    </artifactItem>
                  </artifactItems>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>com.jcabi</groupId>
            <artifactId>jcabi-mysql-maven-plugin</artifactId>
            <configuration>
              <classifier>mysql.classifier</classifier>
              <port>${mysql.port}</port>
              <socket>${mysql.socket}</socket>
              <clearexistingdata>false</clearexistingdata>
              <options>
                <option>lower_case_table_names=${mysql.lower_case_table_names}</option>
              </options>
            </configuration>
            <executions>
              <execution>
                <id>mysql-test</id>
                <goals>
                  <goal>classify</goal>
                  <goal>stop</goal>
                </goals>
              </execution>
              <execution>
                <id>start-mysql</id>
                <goals>
                  <goal>start</goal>
                </goals>
                <phase>package</phase>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>sql-maven-plugin</artifactId>
            <version>1.5</version>
            <dependencies>
              <dependency>
                <groupId>${jdbc.groupId}</groupId>
                <artifactId>${jdbc.artifactId}</artifactId>
                <version>${jdbc.version}</version>
              </dependency>
            </dependencies>
            <configuration>
              <url>${ds.connection.url}</url>
              <driver>${ds.driver.class}</driver>
              <username>${ds.username}</username>
              <password>${ds.password}</password>
            </configuration>
            <executions>
              <execution>
                <goals>
                  <goal>execute</goal>
                </goals>
                <phase>package</phase>
                <configuration>
                  <sqlCommand>ALTER DATABASE ${ds.database} CHARACTER SET utf8 COLLATE utf8_general_ci;</sqlCommand>
                  <srcFiles>
                    <!-- we can take a snapshot of the database in previous run -->
                    <!-- see server/etc/scripts/functional-test-db-snapshot.sh -->
                    <!-- see server/etc/scripts/cargowait.sh -->
                    <srcFile>${project.build.directory}/database.sql</srcFile>
                  </srcFiles>
                  <onError>continue</onError>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.codehaus.cargo</groupId>
            <artifactId>cargo-maven2-plugin</artifactId>
            <configuration combine.self="append">
              <configuration>
                <properties>
                  <cargo.servlet.port>${cargo.servlet.port}</cargo.servlet.port>
                  <cargo.jboss.management-http.port>${cargo.jboss.management-http.port}</cargo.jboss.management-http.port>
                  <cargo.jboss.management-native.port>${cargo.jboss.management-native.port}</cargo.jboss.management-native.port>
                </properties>
              </configuration>
              <deployables>
                <deployable>
                  <groupId>${project.groupId}</groupId>
                  <artifactId>zanata-test-war</artifactId>
                  <type>war</type>
                  <pingURL>http://${cargo.host}:${cargo.servlet.port}/${context.path}/</pingURL>
                  <pingTimeout>600000</pingTimeout>
                  <properties>
                    <context>${context.path}</context>
                  </properties>
                </deployable>
              </deployables>
            </configuration>
            <executions>
              <execution>
                <id>cargo-start</id>
                <phase>pre-integration-test</phase>
                <goals>
                  <goal>start</goal>
                </goals>
                <configuration>
                  <configuration>
                    <properties>
                      <cargo.jvmargs>
                        <!-- NB: JDom parser doesn't like comments starting with '-' -->
                        -XX:-OmitStackTraceInFastThrow
                        -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=target
                        -XX:PermSize=512m -XX:MaxPermSize=1024
                        -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled
                        ${cargo.debug.jvm.args}
                      </cargo.jvmargs>
                    </properties>
                  </configuration>
                </configuration>
              </execution>
              <execution>
                <id>default-cli</id>
                <configuration>
                  <configuration>
                    <properties>
                      <cargo.jvmargs>
                        <!-- NB: JDom parser doesn't like comments starting with '-' -->
                        -XX:-OmitStackTraceInFastThrow
                        -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=target
                        -XX:PermSize=512m -XX:MaxPermSize=1024
                        -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled
                        ${cargo.debug.jvm.args}
                      </cargo.jvmargs>
                    </properties>
                  </configuration>
                </configuration>
              </execution>
              <execution>
                <id>cargo-stop</id>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>stop</goal>
                </goals>
              </execution>
            </executions>
          </plugin>

          <plugin>
            <artifactId>maven-failsafe-plugin</artifactId>
            <configuration>
              <runOrder>alphabetical</runOrder>
              <!--<forkMode>always</forkMode>-->
              <includes>
                <include>${include.test.patterns}</include>
              </includes>
              <properties>
                <property>
                  <name>listener</name>
                  <value>org.zanata.util.ScreenshotEnabledTestRunListener,org.zanata.util.FeatureInventoryRecorder,org.zanata.util.TestLogger</value>
                </property>
              </properties>
              <systemPropertyVariables>
                <featureInventoryLocation>${project.build.directory}/test-classes/feature-inventory</featureInventoryLocation>
                <maven.home>${maven.home}</maven.home>
              </systemPropertyVariables>
            </configuration>
          </plugin>
        </plugins>
      </build>
    </profile>

    <profile>
      <id>JBOSS_HTTP_PORT</id>
      <activation>
        <property>
          <name>env.JBOSS_HTTP_PORT</name>
        </property>
      </activation>
      <properties>
        <cargo.servlet.port>${env.JBOSS_HTTP_PORT}</cargo.servlet.port>
      </properties>
    </profile>

    <profile>
      <id>JBOSS_MANAGEMENT_HTTP_PORT</id>
      <activation>
        <property>
          <name>env.JBOSS_MANAGEMENT_HTTP_PORT</name>
        </property>
      </activation>
      <properties>
        <cargo.jboss.management-http.port>${env.JBOSS_MANAGEMENT_HTTP_PORT}</cargo.jboss.management-http.port>
      </properties>
    </profile>

    <profile>
      <id>JBOSS_MANAGEMENT_NATIVE_PORT</id>
      <activation>
        <property>
          <name>env.JBOSS_MANAGEMENT_NATIVE_PORT</name>
        </property>
      </activation>
      <properties>
        <cargo.jboss.management-native.port>${env.JBOSS_MANAGEMENT_NATIVE_PORT}</cargo.jboss.management-native.port>
      </properties>
    </profile>

    <profile>
      <id>SMTP_PORT</id>
      <activation>
        <property>
          <name>env.SMTP_PORT</name>
        </property>
      </activation>
      <properties>
        <smtp.port>${env.SMTP_PORT}</smtp.port>
      </properties>
    </profile>
  </profiles>

  <build>
    <!-- NB: targetPath MUST be relative to target/test-classes -->
    <testResources>
      <!-- various config files, with filtering -->
      <testResource>
        <directory>src/test/resources</directory>
        <filtering>true</filtering>
        <includes>
          <include>**/*.properties</include>
          <include>**/*.xml</include>
        </includes>
      </testResource>
      <!-- test documents, no filtering -->
      <testResource>
        <directory>src/test/resources</directory>
        <filtering>false</filtering>
          <includes>
          <include>**/*.odt</include>
          <include>**/*.odg</include>
          <include>**/*.ods</include>
          <include>**/*.odp</include>
          <include>**/*.idml</include>
        </includes>
      </testResource>
      <!-- browser extension(s), no filtering -->
      <testResource>
        <directory>src/test/resources/zanata-testing-extension</directory>
        <filtering>false</filtering>
        <targetPath>zanata-testing-extension</targetPath>
      </testResource>
      <!-- more config files, with filtering -->
      <testResource>
        <directory>src/test/resources/zanata-user-config</directory>
        <filtering>true</filtering>
      </testResource>
      <!-- html/js files for displaying feature inventory -->
      <testResource>
        <directory>src/test/resources/feature-inventory</directory>
        <filtering>false</filtering>
        <targetPath>feature-inventory</targetPath>
      </testResource>
    </testResources>

    <plugins>
      <plugin>
        <artifactId>maven-resources-plugin</artifactId>
        <executions>
          <execution>
            <id>default</id>
            <phase>process-test-resources</phase>
            <goals>
              <goal>copy-resources</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <outputDirectory>target/test-classes/</outputDirectory>
          <resources>
            <!-- files under sample-projects, with filtering for config files -->
            <resource>
              <directory>sample-projects</directory>
              <targetPath>sample-projects</targetPath>
              <filtering>true</filtering>
              <includes>
                <include>**</include>
              </includes>
            </resource>
          </resources>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.codehaus.gmaven</groupId>
        <artifactId>gmaven-plugin</artifactId>
        <executions>
          <execution>
            <id>clean</id>
            <phase>clean</phase>
            <goals>
              <goal>execute</goal>
            </goals>
            <configuration>
              <properties>
                <delete>true</delete>
              </properties>
              <!-- Sets property mysql.socket -->
              <source>${project.basedir}/etc/mysql-socket.groovy</source>
            </configuration>
          </execution>
          <execution>
            <id>initialize</id>
            <phase>initialize</phase>
            <goals>
              <goal>execute</goal>
            </goals>
            <configuration>
              <properties>
                <delete>false</delete>
              </properties>
              <!-- Sets property mysql.socket -->
              <source>${project.basedir}/etc/mysql-socket.groovy</source>
            </configuration>
          </execution>
        </executions>
        <dependencies>
          <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
            <version>2.4</version>
          </dependency>
        </dependencies>
      </plugin>

      <plugin>
        <groupId>org.codehaus.gmavenplus</groupId>
        <artifactId>gmavenplus-plugin</artifactId>
        <executions>
          <execution>
            <id>default</id>
            <goals>
              <goal>addSources</goal>
              <goal>addTestSources</goal>
              <goal>generateStubs</goal>
              <goal>compile</goal>
              <goal>testGenerateStubs</goal>
              <goal>testCompile</goal>
              <goal>removeStubs</goal>
              <goal>removeTestStubs</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <!-- if including source jars, use the no-fork goals
             otherwise both the Groovy sources and Java stub sources will get included in your jar -->
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-source-plugin</artifactId>
        <executions>
          <execution>
            <id>attach-sources</id>
            <goals>
              <goal>jar-no-fork</goal>
              <goal>test-jar-no-fork</goal>
            </goals>
          </execution>
        </executions>
      </plugin>

      <plugin>
        <artifactId>maven-antrun-plugin</artifactId>
        <executions>
          <execution>
            <id>init-no-appserver</id>
            <phase>initialize</phase>
          </execution>
          <execution>
            <phase>generate-resources</phase>
            <goals>
              <goal>run</goal>
            </goals>
            <configuration>
              <target>
                <echo>===== Properties that can be set for functional test =====</echo>
                <echo>-DskipFuncTests : to skip running functional tests, and/or:</echo>
                <echo>-DskipArqTests : to skip Arquillian integration tests (if building zanata-war)</echo>
                <echo />
                <echo>Unless skipping tests, you must choose an appserver:</echo>
                <echo>-Dappserver=jbosseap6 or -Dappserver=wildfly8</echo>
                <echo>For jbosseap6, env var EAP7_URL should point to an EAP zip file.</echo>
                <echo />
                <echo>-DallFuncTests to enable all functional tests (defaults to smoke tests)</echo>
                <echo />
                <echo>-Dcargo.debug.jvm.args : If not set by default will listen to port 8787. Need to set to empty on jenkins</echo>
                <echo />
                <echo>-Dzanata.target.version=version of zanata to deploy. Default is: ${project.parent.version}</echo>
                <echo>-Dzanata.instance.url=http://${cargo.host}:${cargo.servlet.port}/${context.path}</echo>
                <echo>-Dzanata.apikey=b6d7044e9ee3b2447c28fb7c50d86d98</echo>
                <!--<echo>-Dzanata.client.version=maven client version to use. Currently: ${zanata.client.version}</echo>-->
                <echo>-Dzanata.sample.projects.basedir=${project.build.testOutputDirectory}/sample-projects</echo>
                <echo>-Dinclude.test.patterns=test filter pattern. Can be used to control what test to run. Default is ${default.test.patterns}</echo>
                <echo>-Dwebdriver.type=run tests in htmlUnit, chrome or firefox. For chrome, see also webdriver.chrome.* Default is chrome.</echo>
                <echo>-Dwebdriver.chrome.bin=full path to chrome binary.</echo>
                <echo>-Dwebdriver.chrome.driver=full path to chromedriver binary. Default is chromedriver on $PATH</echo>
                <echo>-Dwebdriver.wait=global wait time in seconds for element searches. Default is 10.</echo>
                <echo>-Dwebdriver.screenshot.dir=location to store screenshots during test execution.Default is ${project.build.directory}/screenshots</echo>
                <echo>NB: set env var DISPLAY to run test browser in alternative display, for Xnest/Xvfb/Xvnc. eg: xvfb-run -e mvn verify -Dappserver=wildfly8</echo>
                <echo>==========================================================</echo>
                <echo>to ask cargo to start up then wait so that tests can be run manually: mvn clean package cargo:run -Dappserver=wildfly8 -Dmysql.port=13306</echo>
                <!-- placeholder. Actual content should be populated by running server/etc/scripts/functional-test-db-snapshot.sh -->
                <touch file="${project.build.directory}/database.sql" />
              </target>
            </configuration>
          </execution>
          <execution>
            <id>preIT-no-appserver</id>
            <phase>prepare-package</phase>
            <goals><goal>run</goal></goals>
            <configuration>
              <target unless="skipFuncTests">
                <fail message="'appserver' property must be set to run integration tests (or else use -DskipFuncTests)" unless="appserver" />
                <fail message="'cargo.installation' property is null (set env var EAP7_URL or else use -DskipFuncTests)" unless="cargo.installation" />
              </target>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-dependency-plugin</artifactId>
        <configuration>
          <usedDependencies combine.children="append">
            <usedDependency>mysql:mysql-connector-java</usedDependency>
          </usedDependencies>
        </configuration>
      </plugin>

      <plugin>
        <artifactId>maven-deploy-plugin</artifactId>
        <!-- No point in deploying this without zanata-war -->
        <configuration>
          <!-- MEAD builds must deploy all artifacts, so we run them with -Dallow.deploy.skip=false -->
          <skip>${allow.deploy.skip}</skip>
        </configuration>
      </plugin>

      <plugin>
        <artifactId>maven-enforcer-plugin</artifactId>
        <configuration>
          <rules>
            <bannedDependencies>
              <excludes combine.children="append">
                <!-- use xalan:xalan -->
                <exclude>jakarta-regexp:jakarta-regexp</exclude>
              </excludes>
              <includes>
                <include>org.jboss.spec.javax.ws.rs:jboss-jaxrs-api_2.0_spec</include>
              </includes>
              <searchTransitive>true</searchTransitive>
            </bannedDependencies>
          </rules>
        </configuration>
      </plugin>

      <!--we want to run tests in integration phase-->
      <plugin>
        <artifactId>maven-surefire-plugin</artifactId>
        <configuration>
          <skip>true</skip>
        </configuration>
      </plugin>

      <plugin>
        <groupId>org.codehaus.cargo</groupId>
        <artifactId>cargo-maven2-plugin</artifactId>
        <!-- this plugin configuration is shared by two profiles: functional-test and wildfly -->
        <configuration>
          <container>
            <type>installed</type>
            <home>${appserver.home}</home>

            <systemProperties>
              <jboss.server.log.threshold>WARN</jboss.server.log.threshold>
              <hibernate.search.default.indexBase>${hibernate.search.default.indexBase}</hibernate.search.default.indexBase>
              <javamelody.storage-directory>${javamelody.storage-directory}</javamelody.storage-directory>
              <jboss.socket.binding.port-offset>${cargo.port.offset}</jboss.socket.binding.port-offset>
            </systemProperties>

            <timeout>120000</timeout>
          </container>

          <configuration>
            <type>standalone</type>
            <home>${cargo.container.home}</home>

            <configfiles>
              <configfile>
                <file>${project.basedir}/src/test/conf/zanata-ds.xml</file>
                <todir>deployments</todir>
              </configfile>
              <!-- see above zipUrlInstaller/extractDir-->
              <!-- cargo will force todir and tofile to be relative to container home directory -->

              <!-- security and jndi for properties -->
              <configfile>
                <file>${project.basedir}/src/test/conf/${standalone.xml.file}</file>
                <tofile>configuration/standalone.xml</tofile>
              </configfile>

            </configfiles>

            <files>
              <file>
                <file>${settings.localRepository}/${jdbc.groupId}/${jdbc.artifactId}/${jdbc.version}/${jdbc.artifactId}-${jdbc.version}.jar</file>
                <tofile>deployments/${jdbc.artifactId}.jar</tofile>
              </file>
            </files>

            <properties>
              <cargo.jboss.configuration>standalone</cargo.jboss.configuration>
              <cargo.port.offset>${cargo.port.offset}</cargo.port.offset>
              <cargo.jboss.ajp.port>8109</cargo.jboss.ajp.port>
              <!-- These properties will be interpolated by Cargo into the configfiles above -->
              <ds.connection.url>${ds.connection.url}</ds.connection.url>
              <ds.username>${ds.username}</ds.username>
              <ds.password>${ds.password}</ds.password>
              <jdbc.artifactId>${jdbc.artifactId}</jdbc.artifactId>
              <smtp.port>${smtp.port}</smtp.port>
            </properties>
          </configuration>
        </configuration>
      </plugin>
    </plugins>
    <pluginManagement>
      <plugins>
        <!--This plugin's configuration is used to store Eclipse m2e settings only. It has no influence on the Maven build itself.-->
        <plugin>
          <groupId>org.eclipse.m2e</groupId>
          <artifactId>lifecycle-mapping</artifactId>
          <version>1.0.0</version>
          <configuration>
            <lifecycleMappingMetadata>
              <pluginExecutions>
                <pluginExecution>
                  <pluginExecutionFilter>
                    <groupId>
                      org.apache.maven.plugins
                    </groupId>
                    <artifactId>
                      maven-antrun-plugin
                    </artifactId>
                    <versionRange>
                      [1.7,)
                    </versionRange>
                    <goals>
                      <goal>run</goal>
                    </goals>
                  </pluginExecutionFilter>
                  <action>
                    <ignore />
                  </action>
                </pluginExecution>
              </pluginExecutions>
            </lifecycleMappingMetadata>
          </configuration>
        </plugin>

        <!-- We don't want to check coverage here -->
        <plugin>
          <groupId>org.jacoco</groupId>
          <artifactId>jacoco-maven-plugin</artifactId>
          <configuration>
            <excludes>
              <exclude>**</exclude>
            </excludes>
          </configuration>
        </plugin>
      </plugins>
    </pluginManagement>
  </build>
</project>
