<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
  ~ Copyright 2017, Red Hat, Inc. and individual contributors as indicated by the
  ~ @author tags. See the copyright.txt file in the distribution for a full
  ~ listing of individual contributors.
  ~
  ~ This is free software; you can redistribute it and/or modify it under the
  ~ terms of the GNU Lesser General Public License as published by the Free
  ~ Software Foundation; either version 2.1 of the License, or (at your option)
  ~ any later version.
  ~
  ~ This software is distributed in the hope that it will be useful, but WITHOUT
  ~ ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
  ~ FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
  ~ details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public License
  ~ along with this software; if not, write to the Free Software Foundation,
  ~ Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA, or see the FSF
  ~ site: http://www.fsf.org.
  -->

<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

  <changeSet author="pahuang@redhat.com" id="1">
    <comment>Fix up potential referential constraint problem in HProject_LocaleMember table</comment>
    <sql>
      delete from HProject_LocaleMember where personId NOT in (select id from HPerson)
    </sql>
    <addForeignKeyConstraint baseTableName="HProject_LocaleMember"
      baseColumnNames="personId"
      constraintName="FK_HProject_LocaleMember_HPerson"
      referencedTableName="HPerson" referencedColumnNames="id"
      onDelete="CASCADE" />
    <addForeignKeyConstraint baseTableName="HProject_LocaleMember"
      baseColumnNames="localeId"
      constraintName="FK_HProject_LocaleMember_HLocale"
      referencedTableName="HLocale" referencedColumnNames="id" />
    <addForeignKeyConstraint baseTableName="HProject_LocaleMember"
      baseColumnNames="projectId"
      constraintName="FK_HProject_LocaleMember_HProject"
      referencedTableName="HProject" referencedColumnNames="id"
      onDelete="CASCADE" />
  </changeSet>

  <changeSet id="2" author="pahuang@redhat.com">
    <comment>Fix up potential referential constraints in HProject_LocaleMember table</comment>
    <sql>
      delete from HProject_LocaleMember where localeId NOT in (select id from HLocale)
    </sql>
    <dropForeignKeyConstraint baseTableName="HProject_LocaleMember" constraintName="FK_HProject_LocaleMember_HLocale" />
    <addForeignKeyConstraint baseTableName="HProject_LocaleMember"
      baseColumnNames="localeId"
      constraintName="FK_HProject_LocaleMember_HLocale"
      referencedTableName="HLocale" referencedColumnNames="id"
      onDelete="CASCADE" />
  </changeSet>

  <changeSet id="3" author="pahuang@redhat.com">
    <comment>add missing constraints</comment>
    <addForeignKeyConstraint baseTableName="HTextFlowTarget"
      baseColumnNames="reviewed_by_id"
      constraintName="FK_HTextFlowTarget_reviewer"
      referencedTableName="HPerson" referencedColumnNames="id" />
    <addForeignKeyConstraint baseTableName="HTextFlowTarget"
      baseColumnNames="translated_by_id"
      constraintName="FK_HTextFlowTarget_translator"
      referencedTableName="HPerson"
      referencedColumnNames="id" />
    <addForeignKeyConstraint baseTableName="HTextFlowTargetHistory"
      baseColumnNames="reviewed_by_id"
      constraintName="FK_HTextFlowTargetHistory_reviewer"
      referencedTableName="HPerson" referencedColumnNames="id" />
    <addForeignKeyConstraint baseTableName="HTextFlowTargetHistory"
      baseColumnNames="translated_by_id"
      constraintName="FK_HTextFlowTargetHistory_translator"
      referencedTableName="HPerson"
      referencedColumnNames="id" />

  </changeSet>

  <changeSet id="4" author="pahuang@redhat.com">
    <comment>drop duplicate index and add missing index, unique constraints</comment>
    <dropIndex tableName="HTextFlowTargetHistory" indexName="Idx_lastModifiedBy" />
    <createIndex tableName="TransMemoryUnit" indexName="Idx_TransMemoryUnit_tm_id">
      <column name="tm_id"/>
    </createIndex>
    <createIndex tableName="HProjectIteration_Locale"
      indexName="Idx_HProjectIteration_Locale_projectIterationId">
      <column name="projectIterationId"/>
    </createIndex>
    <addUniqueConstraint tableName="HTextFlowContentHistory"
      columnNames="text_flow_history_id,pos" />
    <addUniqueConstraint tableName="HTextFlowTargetContentHistory"
      columnNames="text_flow_target_history_id,pos" />
  </changeSet>

  <changeSet id="5" author="pahuang@redhat.com">
    <comment>Add missing constraints in HProject_Member table</comment>
    <sql>
      delete from HProject_Member where personId NOT in (select id from HPerson) or projectId NOT in (select id from HProject)
    </sql>
    <addForeignKeyConstraint baseTableName="HProject_Member"
      baseColumnNames="projectId"
      constraintName="FK_HProject_Member_projectId"
      referencedTableName="HProject"
      referencedColumnNames="id"/>
    <addForeignKeyConstraint baseTableName="HProject_Member"
      baseColumnNames="personId"
      constraintName="FK_HProject_Member_personId" referencedTableName="HPerson"
      referencedColumnNames="id" />
  </changeSet>

</databaseChangeLog>
