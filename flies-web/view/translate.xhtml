<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:flies="http://flies.fedorahosted.org/ui"
    xmlns:a4j="http://richfaces.org/a4j"
    template="layout/template_fullpage.xhtml">

  <ui:define name="head">
    <script type="text/javascript">
      //<![CDATA[
      jQuery(document).ready(function() {

          //jQuery(ChiliBook.automaticSelector).chili();
      });

      jQuery(window).resize(function() {

    	  var areaDiv = jQuery("#TransArea");
          var headerDiv = jQuery("#TransAreaHeader");
          var footerDiv = jQuery("#TransAreaFooter");
          var contentDiv = jQuery("#TransAreaContent");
          
          var height = jQuery(window).height();
          height -= areaDiv.outerHeight(true) - areaDiv.height();
          height -= headerDiv.outerHeight(true);
          height -= footerDiv.outerHeight(true);
          height -= contentDiv.outerHeight(true) - contentDiv.height();
          contentDiv.height( height);
          
      });

      function tuSelect(tr){
          // hide the current active row
          var activeRow = jQuery(tr).parent().find(".active-row");
          activeRow.removeClass('active-row');
          activeRow.find('.tuEditMode').hide();
          activeRow.find('.tuViewMode').show();

          // set the ideal size for the textarea
          var editArea = jQuery(tr).find('textarea');
          var td = editArea.parent().parent();
          
          var h = td.innerHeight();
          h -= parseInt(td.css('paddingTop'));
          h -= parseInt(td.css('paddingBottom'));
          h -= editArea.outerHeight(true) - editArea.height()
          
          var w = td.innerWidth();
          w -= parseInt(td.css('paddingLeft'));
          w -= parseInt(td.css('paddingRight'));
          w -= editArea.outerWidth(true) - editArea.width()
          
          editArea.height(h);
          editArea.width(w);

          jQuery(tr).find('.tuViewMode').hide();
          jQuery(tr).addClass('active-row'); 
          jQuery(tr).find('.tuEditMode').show();
      }

      function tuNext(){
          alert('next');
      }

      function tuPrevious(){
          alert('prev');
      }

      function tuCancel(){
          var activeRow = jQuery("#TransAreaContent").find(".active-row");
          activeRow.removeClass('active-row');
          activeRow.find('.tuEditMode').hide();
          activeRow.find('.tuViewMode').show();
          return false;
      }
                
      //]]>
    </script>  
  </ui:define>

  <ui:define name="page-title">
    #{translateAction.project.name} (#{translateAction.project.projectId}) 
    to #{translateAction.locale} - 
  </ui:define>

  <ui:define name="left_content">

    <a4j:form>
      <a4j:poll action="#{translateAction.ping()}" interval="5000" reRender="translatorsPanel"/>
    </a4j:form>
    
    <rich:panel bodyClass="panel-body-no-padding">
      <f:facet name="header">Project Tree</f:facet>
      <h:form>
        <a4j:region id="ProjectTreeRegion">
          <rich:dataTable id="documentsTable" value="#{documentTargets}" var="doc" rows="15" reRender="ds" rowClasses="docrow">
            <rich:column filterBy="#{doc.template.name}" filterEvent="onkeyup">
              <a4j:commandLink reRender="documentsTable,TransAreaTable" action="#{translateAction.selectDocumentTarget}">
                <s:conversationId name="wid"/>
                <h:outputText value="#{doc.template.name}" /> 
              </a4j:commandLink>
            </rich:column>
            <f:facet name="footer">
              <rich:datascroller id="ds" rendered="#{documentTargets.size > 50}" styleClass="datacsr-mini"></rich:datascroller>
            </f:facet>
          </rich:dataTable>
        </a4j:region>
      </h:form>
    </rich:panel>
    <br/>
    <rich:panel id="filterPanel">
      <f:facet name="header">Search and Filter</f:facet>
      No content
    </rich:panel>
    <br/>
    <rich:panel id="translatorsPanel">
      <f:facet name="header">#{translateAction.workspace.translatorCount} translator(s) online</f:facet>
      <rich:dataTable width="150px" value="#{translateAction.workspace.translators}" var="translator">
        <rich:column>
          <img src="#{request.contextPath}/img/silk/user.png"/>
        </rich:column>
        <rich:column>
          #{translator.name}
        </rich:column>
        <rich:column>
          <div class="translator_color_block translator_color_block_#{translator.id}"/>
        </rich:column>
      </rich:dataTable>
      <!-- 
      <h3 style="border-bottom:1px solid;">Chat</h3>
      <strong>Asgeir:</strong> hello world...<br/>
      <strong>Admin:</strong> let them eat cake..
      <h:inputTextarea value="hello world" style="width:100%; height:50px;"/>
       -->
    </rich:panel>
  </ui:define>
  
  <ui:define name="center_content">
    <rich:jQuery selector="#tab_home" query="addClass('ui-tabs-selected')" />
    <h:form>
      <a4j:region id="TransAreaRegion">
        <div id="TransArea">
          <div id="TransAreaLoadingStatus" style="position:absolute; left:50%; top:50%;">
            <a4j:status for="TransAreaRegion" >
                <f:facet name="start">
                    <h:graphicImage  value="/img/spinner2-greenie.gif" style="position: relative; left:-24px; top:-24px;"/>
                </f:facet>
            </a4j:status>
            <a4j:status for="ProjectTreeRegion" >
                <f:facet name="start">
                    <h:graphicImage  value="/img/spinner2-greenie.gif" style="position: relative; left:-24px; top:-24px;"/>
                </f:facet>
            </a4j:status>
          </div>
        
          <div id="TransAreaHeader">
            Header goes here...
          </div>
          <div id="TransAreaContent">
            <rich:dataTable id="TransAreaTable" 
                width="auto"  
                value="#{textFlowTargets}" 
                var="tut" 
                rows="20" 
                height="auto" 
                reRender="tuds"
                rowClasses="odd,even"
                selection="#{translateAction.selectedRow}"
              >
              <rich:column label="Source" width="50%" style="overflow:hidden;">
                <div id="SourceContent_#{tut.textFlow.id}" class="tuSourceContent">
                  <p id="SourceContentHtml_#{tut.textFlow.id}" class="html">#{tut.textFlow.content}</p>
                </div>
                <script type="text/javascript">
                  //<![CDATA[
                  // add highlighting to source 
                  var sourceContent = jQuery('#SourceContentHtml_#{tut.textFlow.id}');
                  sourceContent.chili();
                  //]]>
                </script>                     
              </rich:column>
              <rich:column label="Target" width="50%" style="overflow:hidden;">
                <div id="TargetContent_#{tut.id}" class="tuPane" style="position: relative;">
                  <h:inputTextarea id="TargetContentEdit_#{tut.id}" value="#{tut.content}" styleClass="tuTargetContent tuEditMode"/>
                  <div id="TargetContentView_#{tut.id}" class="tuTargetContent tuViewMode">
                    <p id="TargetContentHtml_#{tut.id}" class="html">#{tut.content}</p>
                  </div>
                  <div id="TargetContentActions_#{tut.id}" class="tuEditMode tuActionButtons" style="display: none">
                    <a4j:commandLink
                      id="TargetContentActions_Save_#{tut.id}" 
                      action="#{translateAction.persistChanges}" 
                      reRender="tuTargetContentView">
                      <s:conversationId name="wid"/>
                      <img src="#{request.contextPath}/img/silk/tick.png"/>
                    </a4j:commandLink>
                    <a 
                      id="TargetContentActions_Cancel_#{tut.id}"
                      href="#"> 
                      <img src="#{request.contextPath}/img/silk/cross.png"/>
                    </a>
                    <h:outputLink 
                      id="TargetContentActions_Prev_#{tut.id}" 
                      value="#"
                      onclick="tuPrevious()">
                      <img src="#{request.contextPath}/img/silk/resultset_previous.png"/>
                    </h:outputLink>
                    <h:outputLink 
                      id="TargetContentActions_Next_#{tut.id}" 
                      value="#"
                      onclick="tuNext()">
                      <img src="#{request.contextPath}/img/silk/resultset_next.png"/>
                    </h:outputLink>
                  </div>
                </div>
                <script type="text/javascript">
                  //<![CDATA[
                  
                  
                  var targetDiv = jQuery('#TargetContent_#{tut.id}');
                  var trElem = targetDiv.parent().parent();
                  // highlight target content
                  jQuery('#TargetContentHtml_#{tut.id}').chili();

                  // row hover coloring
                  
                  trElem.hover( 
                      function(){ 
                        jQuery(this).addClass('hover-row')
                      }, 
                      function(){
                        jQuery(this).removeClass('hover-row')      
                      }
                   ); 

                   trElem.click( function(){
                      
                	  if( jQuery(this).hasClass('active-row') ) 
                        return false;
                      tuSelect(this);
                      
                   });

                   var cancelA = jQuery('#TargetContentActions_Cancel_#{tut.id}');
                   cancelA.click( function(e) {
                       tuCancel();
                       return false;
                   });
                   
                  //]]>
                </script>                     
              </rich:column>
            </rich:dataTable>

          </div>
          <div id="TransAreaFooter">
            <div id="TransAreaFooterLeft">
              <em>#{textFlowTargets.size} translation units.</em>
            </div>
            <div id="TransAreaFooterCenter">
              <rich:datascroller for="TransAreaTable" 
                  styleClass="TransAreaDataScroller"
                  id="tuds" 
                  reRender="TransAreaTable" 
                  rendered="#{textFlowTargets.size > 50}"/>
            </div>
            <div id="TransAreaFooterRight">
              <flies:translation-status-bar
                title="Blah"
                translated="34" 
                fuzzy="1" 
                untranslated="45"/>
            </div>
          </div>        
        </div> <!-- TransArea -->
      </a4j:region>
    </h:form>
  </ui:define>

  <ui:define name="right_content">
    <rich:panel id="tuInfoPanel">
      <f:facet name="header">Translation Unit Information</f:facet>
      <s:div rendered="#{selectedTextFlowTarget == null}">No unit selected</s:div>
      <s:div rendered="#{selectedTextFlowTarget != null}">
        <strong>Last Translator: </strong> <em>Unknown</em><br/>
      </s:div>
    </rich:panel>
    <br/>
    <rich:panel>
      <f:facet name="header">Terminology</f:facet>
      <em>No Glossaries defined</em>
    </rich:panel>
    <br/>
  </ui:define>
  
</ui:composition>
