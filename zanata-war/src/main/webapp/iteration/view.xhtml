<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	template="../WEB-INF/layout/template.xhtml">


    <ui:define name="page_title">#{viewAllStatusAction.projectSlug}:#{viewAllStatusAction.iterationSlug}</ui:define>

    <ui:define name="head">
        <script type="text/javascript">
            function copyTransLinkClicked()
            {
                if(#{viewAllStatusAction.projectIteration.documents.size() > 0})
                {
                    return confirm('#{messages['jsf.iteration.CopyTrans.confirm']}');
                }
                else
                {
                    alert('#{messages['jsf.iteration.CopyTrans.noDocuments']}');
                    return false;
                }
            }
        </script>
    </ui:define>

    <ui:define name="center_content">
		<rich:jQuery selector="#tab_projects" query="addClass('ui-tabs-selected')" />
			
		<h1>
	       #{messages['jsf.ProjectId']}:&nbsp;
	       <s:link view="/project/view/#{viewAllStatusAction.projectSlug}" styleClass="table_link">
	           #{viewAllStatusAction.projectSlug}
	       </s:link>
	    </h1>
        <h1>
            #{messages['jsf.Version']}:&nbsp;
            #{viewAllStatusAction.iterationSlug}
        </h1>
			
		<rich:panel id="iteration-status-panel">
		
			<ui:include src="/WEB-INF/layout/loading.xhtml">
				<ui:param name="regionId" value="langTableRegion"/>
			</ui:include>
		
			<a4j:form>
				<a4j:region id="langTableRegion">
					<s:token allowMultiplePosts="true" />
					
					<h:selectBooleanCheckbox id="show_all_locales" 
						value="#{viewAllStatusAction.showAllLocales}"
						title="#{messages['jsf.iteration.ShowAllLocales.title']}"
						rendered="#{identity.loggedIn}">
						<a4j:support event="onclick"
	                            ajaxSingle="true"
	                            reRender="data_table"/>
					</h:selectBooleanCheckbox>
					<h:outputText value="#{messages['jsf.iteration.ShowAllLocales']}" rendered="#{identity.loggedIn}"/>
					<rich:spacer width="10px;"/>
					<br/>
					<rich:spacer height="10px;"/>
					
					<rich:dataTable id="data_table" width="100%"
						value="#{viewAllStatusAction.getAllStatus().toArray()}" var="stats"
						styleClass="iteration_inline_tribes" rowClasses="odd,even">
						<rich:column sortBy="#{stats.locale}"
							styleClass="#{viewAllStatusAction.showAllLocales and stats.userInLanguageTeam ? 'highlighted_datatable_row' : ''}">
							<f:facet name="header">#{messages['jsf.Language']}</f:facet>
							<h:outputLink rendered="#{identity.loggedIn}"
								value="#{request.contextPath}/webtrans/Application.html"
								title="#{messages['jsf.iteration.stats.OpenInWebEditor']}" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
								<f:param name="locale" value="#{locale.language}" />
								<h:outputText value="#{stats.locale}" />
							</h:outputLink>
							<h:outputText value="#{stats.locale}"
								rendered="#{not identity.loggedIn}" />
						</rich:column>
						<rich:column sortBy="#{stats.nativeName}"
							styleClass="#{viewAllStatusAction.showAllLocales and stats.userInLanguageTeam ? 'highlighted_datatable_row' : ''}">
							<f:facet name="header">#{messages['jsf.Name']}</f:facet>
							<h:outputLink rendered="#{identity.loggedIn}"
								value="#{request.contextPath}/webtrans/Application.html"
								title="#{messages['jsf.iteration.stats.OpenInWebEditor']}" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
								<f:param name="locale" value="#{locale.language}" />
								<h:outputText value="#{stats.nativeName}" />
							</h:outputLink>
							<h:outputText value="#{stats.nativeName}"
								rendered="#{not identity.loggedIn}" />
						</rich:column>
						<rich:column id="translate" 
							rendered="#{identity.loggedIn and not viewAllStatusAction.isIterationObsolete()}"
							styleClass="#{viewAllStatusAction.showAllLocales and stats.userInLanguageTeam ? 'highlighted_datatable_row' : ''}">
							<h:outputLink
								rendered="#{not applicationConfiguration.debug and not viewAllStatusAction.isUserAllowedToTranslate(stats.locale) }"
								value="#{request.contextPath}/webtrans/Application.html" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
								<f:param name="locale" value="#{locale.language}" />
								#{messages['jsf.Open']}
							</h:outputLink>
	
							<h:outputLink
								rendered="#{applicationConfiguration.debug and not viewAllStatusAction.isUserAllowedToTranslate(stats.locale)}"
								value="#{request.contextPath}/webtrans/Application.html" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
								<f:param name="locale" value="#{locale.language}" />
								<f:param name="gwt.codesvr" value="127.0.0.1:9997" />
								#{messages['jsf.OpenGWTDevMode']}
	      					</h:outputLink>
	
							<h:outputLink
								rendered="#{not applicationConfiguration.debug and viewAllStatusAction.isUserAllowedToTranslate(stats.locale)}"
								value="#{request.contextPath}/webtrans/Application.html" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
								<f:param name="locale" value="#{locale.language}" />
								#{messages['jsf.Translate']}
	      					</h:outputLink>
	      					
							<h:outputLink
								rendered="#{applicationConfiguration.debug and viewAllStatusAction.isUserAllowedToTranslate(stats.locale)}"
								value="#{request.contextPath}/webtrans/Application.html" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
								<f:param name="locale" value="#{locale.language}" />
								<f:param name="gwt.codesvr" value="127.0.0.1:9997" />
								#{messages['jsf.TranslateGWTDevMode']}
	      					</h:outputLink>
						</rich:column>
						<rich:column id="files"
							rendered="#{identity.loggedIn}"
							styleClass="#{viewAllStatusAction.showAllLocales and stats.userInLanguageTeam ? 'highlighted_datatable_row' : ''}">
							<s:link
								view="/iteration/files.xhtml" propagation="none"
								value="#{messages['jsf.Files']}" styleClass="iteration_link">
								<f:param name="project" value="#{viewAllStatusAction.projectSlug}" />
								<f:param name="iteration" value="#{viewAllStatusAction.iterationSlug}" />
								<f:param name="localeId" value="#{stats.locale}" />
							</s:link>
						</rich:column>
						<rich:column sortBy="#{stats.per}"
							styleClass="#{viewAllStatusAction.showAllLocales and stats.userInLanguageTeam ? 'highlighted_datatable_row' : ''}">
							<f:facet name="header">Percentage</f:facet>
							<ui:param name="tstatus" value="#{stats.words}" />
							<ui:include src="../WEB-INF/layout/statsbar.xhtml">
								<ui:param name="status" value="#{tstatus}" />
							</ui:include>
						</rich:column>
	
					</rich:dataTable>
				</a4j:region>
			</a4j:form>
		</rich:panel>
	</ui:define>

	<ui:define name="left_content">
		<rich:panel id="loggedIn" rendered="#{identity.loggedIn}">
			<f:facet name="header">#{messages['jsf.Actions']}</f:facet>
			<s:link styleClass="action_link"
				rendered="#{s:hasPermission(viewAllStatusAction.projectIteration, 'update')}"
				value="#{messages['jsf.EditVersion']}" view="/iteration/edit.xhtml"
				propagation="none">
				<f:param name="projectSlug" value="#{viewAllStatusAction.projectSlug}"/>
				<f:param name="slug" value="#{viewAllStatusAction.iterationSlug}" />
			</s:link>
			<s:link styleClass="action_link" 
				value="#{messages['jsf.ConfigFile']}"
				title="#{messages['jsf.GenerateProjectConfig']}"
				action="#{configurationAction.getData}">
				<f:param name="projectSlug" value="#{viewAllStatusAction.projectSlug}" />
				<f:param name="iterationSlug" value="#{viewAllStatusAction.iterationSlug}" />
			</s:link>
            <a4j:outputPanel id="copyTransLink">
                <s:link styleClass="action_link"
                        value="#{messages['jsf.iteration.CopyTrans']}"
                        title="#{messages['jsf.iteration.CopyTrans.title']}"
                        action="#{viewAllStatusAction.startCopyTrans}"
                        rendered="#{s:hasPermission(viewAllStatusAction.projectIteration, 'copy-trans') and not viewAllStatusAction.copyTransRunning}"
                        disabled="#{viewAllStatusAction.copyTransRunning}"
                        onclick="return copyTransLinkClicked()" >
                </s:link>
            </a4j:outputPanel>
		</rich:panel>

        <a4j:form>
            <ui:param name="pHandle" value="#{viewAllStatusAction.copyTransProcessHandle}"/>
            <ui:param name="copyTransRunning" value="#{viewAllStatusAction.copyTransRunning}"/>

            <a4j:outputPanel id="copyTransIndicator" layout="block" rendered="#{identity.loggedIn}">
                <a4j:outputPanel rendered="#{copyTransRunning}">
                    Copy Trans in Progress...
                </a4j:outputPanel>
                <!-- minValue is -1 because of a bug when 0 is used -->
                <rich:progressBar id="copyTransProgressBar"
                                  value="#{viewAllStatusAction.copyTransProgress}"
                                  minValue="-1"
                                  maxValue="#{pHandle.maxProgress - 1}"
                                  interval="900"
                                  ignoreDupResponses="true"
                                  reRender="progressMssgs"
                                  reRenderAfterComplete="copyTransIndicator,copyTransLink">
                </rich:progressBar>
                <a4j:outputPanel id="progressMssgs"
                                 ajaxRendered="true"
                                 layout="block"
                                 rendered="#{copyTransRunning}">
                    <s:div style="text-align:right;" rendered="#{s:hasPermission(viewAllStatusAction.projectIteration, 'copy-trans')}">
                        <h:commandButton value="Cancel" action="#{viewAllStatusAction.cancelCopyTrans}" />
                    </s:div>
                    Started #{pHandle.formattedStartTime} ago by #{pHandle.triggeredBy}
                    <br/>
                    Estimated Time Remaining: #{pHandle.formattedRemainingTime}
                    <br/>
                    Processed documents: #{pHandle.documentsProcessed} of #{viewAllStatusAction.projectIteration.documents.size()}
                </a4j:outputPanel>
            </a4j:outputPanel>
        </a4j:form>
	</ui:define>

</ui:composition>
