#!/bin/sh
if [ $# -lt 1 ]; then
    echo "Usage: $0 <buildNumber>"
    exit 1
fi

BUILD_SERIAL=$1
export HUDSON_HOME="@HUDSON_HOME@"
REPORT_DEST="@HUDSON_HOME@/job/@JOB_NAME@/$BUILD_SERIAL/postBuildResult"
export DISPLAY="@HEADLESS_DISPLAY@"
RESULT_DIR=@RESULT_DIR@

# Wipe out the old results
rm -fr @RESULT_DIR@
mkdir -p @RESULT_DIR@
ctest -V --output-log @TEST_LOGFILE@

RESULT=$?

TESTS=`grep "tests failed out of " @TEST_LOGFILE@ | sed -e 's/^.*tests failed out of //'`
echo "TESTS=$TESTS"
TESTS_FAILED=`grep "% tests passed, " @TEST_LOGFILE@ | sed -e 's/% tests passed, //' |  sed -e 's/ tests.*//'`
echo "TESTS_FAILED=$TESTS_FAILED"
MSG=`grep "% tests passed" @TEST_LOGFILE@`
echo "MSG=$MSG"

cat > @TEST_REPORT_XML@ << EOF
<testsuite errors="0" failures="$TESTS_FAILED" hostname="@HUDSON_HOME@" name="@JOB_NAME@" tests="$TESTS" time="27.169" timestamp="$BUILD_ID">
    <system-out>$MSG</system-out>
    <system-err></system-err>
</testsuite>
EOF

#CMD="curl -X POST -d \"$XML_MSG\" $REPORT_DEST"
#echo "CMD=$CMD"
#eval $CMD

exit $RESULT

